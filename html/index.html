<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
</head>

<body>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>

<script>

$(function () {$.get('http://127.0.0.1:8080/data', data_recvd) });

function data_recvd(data)
{
	sdata = data.split('\n');
	var out = [];
	var out2 = [];
	for(var i = 0;i < sdata.length;i++){
		if (sdata[i].length == 0) {
			if (i != sdata.length-1) {
				alert("Malformed data in the wrong place");
			}

			break;
		}
		fields = sdata[i].split(',');
		var ts = parseInt(fields[0]);
		var probe = fields[2];
		var value = parseInt(fields[3]);

		if (value == -1) {
			value = null;
		}

		if (probe == "google-ping") {
			out.push([ts*1000, value]);
		} else if (probe == "twc-ping") {
			out2.push([ts*1000, value]);
		}
	}

	render_drop_chart("Packet drops on WAN interface", [['google-ping', out], ['twc-ping', out2]]);
}

function render_drop_chart(title, dats) {
	highcharts_config = {
            chart: {
                zoomType: 'x'
            },
            title: {
                text: title
            },
            subtitle: {
                text: document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' :
                    'Pinch the chart to zoom in'
            },
            xAxis: {
                type: 'datetime',
            },
            yAxis: {
                title: {
                    text: 'Percentage lost (%)'
                },
		min: 0,
		max: 100
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                area: {
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    },
                    marker: {
                        radius: 2
                    },
                    lineWidth: 1,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    },
                    threshold: null
                }
            },
        };

	highcharts_config.series = [];
	for (var i=0; i<dats.length; i++) {
		highcharts_config.series.push({
			type: 'area',
			name: dats[i][0],
			data: dats[i][1],
		});
	}

        $('#container').highcharts(highcharts_config);
    }

</script>

<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

</body>

</html>
